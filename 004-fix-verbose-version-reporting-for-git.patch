From 157624aa87f37eedf644f09056cf9141760ce274 Mon Sep 17 00:00:00 2001
From: Austin English <austinenglish@gmail.com>
Date: Sun, 26 Feb 2017 02:05:24 -0600
Subject: [PATCH] fix verbose version reporting for git

Signed-off-by: Austin English <austinenglish@gmail.com>
---
 auxprogs/make_or_upd_vgversion_h | 21 ++++++++-------------
 coregrind/m_main.c               |  2 +-
 2 files changed, 9 insertions(+), 14 deletions(-)

diff --git a/auxprogs/make_or_upd_vgversion_h b/auxprogs/make_or_upd_vgversion_h
index 9a3bee3d9..f72f66f81 100755
--- a/auxprogs/make_or_upd_vgversion_h
+++ b/auxprogs/make_or_upd_vgversion_h
@@ -1,14 +1,10 @@
 #!/bin/sh
 
-extract_svn_version()
+extract_git_version()()
 {
-    if [ -d "$1"/.svn ]
+    if [ -d "$1"/.git ]
     then
-        svnversion -n "$1"
-    elif [ -d "$1"/.git/svn ]
-    then
-        cd "$1" || exit 1
-        git svn info . | grep '^Revision' | cut -d ' ' -f2 | tr -d '\n'
+        git rev-parse --short=10 HEAD
     else
         echo "unknown"
     fi    
@@ -22,18 +18,17 @@ then
 else
     cat > include/vgversion.h.tmp <<EOF
 /* Do not edit: file generated by auxprogs/make_or_upd_vgversion_h.
-   This file defines VGSVN and VEXSVN, used to report SVN revision
-   when using command line options:  -v --version 
+   This file defines VGGIT, used to report GIT revision
+   when using command line options:  -v --version
 */
-#define VGSVN "$(extract_svn_version "$srcdir/.")"
-#define VEXSVN "$(extract_svn_version "$srcdir/VEX")"
+#define VGGIT "$(extract_git_version .)"
 EOF
 fi
 
 if [ -f include/vgversion.h ]
 then
     # There is already a vgversion.h.
-    # Update it only if we found a different and real svn version
+    # Update it only if we found a different and real git version
     if grep -q unknown include/vgversion.h.tmp ||
        cmp -s include/vgversion.h include/vgversion.h.tmp
     then
diff --git a/coregrind/m_main.c b/coregrind/m_main.c
index 87fbc8b30..23d08b1ca 100644
--- a/coregrind/m_main.c
+++ b/coregrind/m_main.c
@@ -428,7 +428,7 @@ static void early_process_cmd_line_options ( /*OUT*/Int* need_help )
       if (VG_(clo_verbosity) <= 1)
          VG_(printf)("valgrind-" VERSION "\n");
       else
-         VG_(printf)("valgrind-" VERSION "-" VGSVN "-vex-" VEXSVN "\n");
+         VG_(printf)("valgrind-" VERSION "-" VGGIT "\n");
       VG_(exit)(0);
    }
 
